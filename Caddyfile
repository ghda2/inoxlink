# Caddy Configuration for Inox Link
# Automatic HTTPS with Let's Encrypt

inoxlink.com.br, www.inoxlink.com.br {
    # Enable HTTP/3
    protocols h1 h2 h3

    # Redirect www to non-www
    @www host www.inoxlink.com.br
    redir @www https://inoxlink.com.br{uri} permanent

    # Security headers
    header {
        # Enable HSTS with preload
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"

        # Enable XSS protection
        X-Frame-Options "SAMEORIGIN"

        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"

        # Content Security Policy (adjust as needed)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://upload-widget.cloudinary.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.cloudinary.com; frame-src 'self' https://widget.cloudinary.com;"

        # Permissions Policy
        Permissions-Policy "geolocation=(), microphone=(), camera=()"

        # Remove server header
        -Server
    }

    # Compression
    encode gzip zstd

    # Proxy to Node app
    reverse_proxy app:4321 {
        # Health check
        health_uri /
        health_interval 30s
        health_timeout 10s
        health_status 200

        # Pass client IP to app
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
    }

    # Logging
    log {
        output file /var/log/caddy/inoxlink.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
        level INFO
    }
}

# Redirect HTTP to HTTPS
http://inoxlink.com.br, http://www.inoxlink.com.br {
    redir https://inoxlink.com.br{uri} permanent
}
