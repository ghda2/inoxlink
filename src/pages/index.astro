---
import Layout from '../layouts/Layout.astro';
import { db } from '../db';
import { news } from '../db/schema';
import { desc, eq } from 'drizzle-orm';

// Get featured news (highest featured level or most recent)
const [featuredNews] = await db.select().from(news)
	.where(eq(news.published, true))
	.orderBy(desc(news.featuredLevel), desc(news.createdAt))
	.limit(1);

// Get other news
const allNews = await db.select().from(news)
	.where(eq(news.published, true))
	.orderBy(desc(news.createdAt))
	.limit(9);

export const prerender = false;
---

<Layout title="Início">
	<section class="space-y-12">
		<!-- Hero Section - Featured News -->
		{featuredNews && (
			<a href={`/noticias/${featuredNews.slug}`} class="block relative overflow-hidden rounded-[2rem] bg-black p-8 md:p-16 text-white min-h-[500px] flex flex-col justify-end group">
				{/* Background Image */}
				{featuredNews.imageUrl && (
					<div class="absolute inset-0">
						<img
							src={featuredNews.imageUrl}
							alt={featuredNews.imageAlt || featuredNews.title}
							class="w-full h-full object-cover opacity-40 group-hover:opacity-50 transition-opacity duration-700"
						/>
					</div>
				)}
				<div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent z-10"></div>

				<div class="relative z-20 space-y-4 max-w-3xl transform transition-transform duration-700 group-hover:translate-y-[-10px]">
					<span class="inline-block px-3 py-1 rounded-full bg-white/10 backdrop-blur-md text-[10px] font-bold tracking-widest uppercase border border-white/20">
						{featuredNews.featuredLevel && featuredNews.featuredLevel > 0 ? 'Destaque' : 'Última Notícia'}
					</span>
					<h1 class="text-4xl md:text-6xl font-black tracking-tight leading-tight italic uppercase">
						{featuredNews.title}
					</h1>
					{featuredNews.excerpt && (
						<p class="text-neutral-300 text-lg md:text-xl font-medium">
							{featuredNews.excerpt}
						</p>
					)}
					<div class="pt-4 flex items-center gap-4">
						<span class="inline-flex h-12 items-center justify-center rounded-full bg-white px-8 text-sm font-bold text-black transition-all group-hover:bg-neutral-200">
							Ler Artigo Completo
						</span>
						{featuredNews.readingTime && (
							<span class="text-sm text-neutral-400 font-bold">
								{featuredNews.readingTime} min de leitura
							</span>
						)}
					</div>
				</div>
			</a>
		)}

		<!-- News Feed -->
		<div class="space-y-8">
			<div class="flex items-end justify-between border-b border-neutral-200 pb-4">
				<h2 class="text-3xl font-black tracking-tighter uppercase italic">Últimas Atualizações</h2>
				<a href="/noticias" class="text-sm font-bold text-neutral-500 hover:text-black transition-colors">Ver todas →</a>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
				{allNews.length > 0 ? allNews.map((item) => (
					<a href={`/noticias/${item.slug}`} class="group space-y-4">
						<div class="relative aspect-video overflow-hidden rounded-2xl bg-neutral-100">
							{item.imageUrl && (
								<img 
									src={item.imageUrl} 
									alt={item.title} 
									class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110"
								/>
							)}
							<div class="absolute inset-0 bg-black/5 group-hover:bg-black/0 transition-colors"></div>
						</div>
						<div class="space-y-2">
							<div class="flex items-center gap-2 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
								<span>{new Date(item.createdAt || '').toLocaleDateString('pt-BR')}</span>
								<span class="w-1 h-1 bg-neutral-300 rounded-full"></span>
								<span>Notícia</span>
							</div>
							<h3 class="text-xl font-bold leading-tight group-hover:text-neutral-600 transition-colors">
								{item.title}
							</h3>
							<p class="text-sm text-neutral-500 line-clamp-2 font-medium">
								{item.excerpt}
							</p>
						</div>
					</a>
				)) : (
					<div class="col-span-full py-20 text-center">
						<div class="inline-flex w-16 h-16 bg-neutral-100 rounded-full items-center justify-center mb-4">
							<div class="w-6 h-6 border-2 border-neutral-300 rounded-sm rotate-45"></div>
						</div>
						<p class="text-neutral-400 font-medium">Nenhuma notícia encontrada no momento.</p>
					</div>
				)}
			</div>
		</div>

		<!-- Wiki Preview Section -->
		<div class="glass rounded-3xl p-12 border-black/5 flex flex-col md:flex-row items-center gap-12">
			<div class="flex-1 space-y-6">
				<div class="w-12 h-12 bg-black rounded-xl flex items-center justify-center">
					<span class="text-white font-black text-xl">W</span>
				</div>
				<h2 class="text-4xl font-black tracking-tighter leading-tight italic">INOX WIKI: SUA ENCICLOPÉDIA TÉCNICA</h2>
				<p class="text-neutral-500 text-lg font-medium leading-relaxed">
					Aprenda sobre tipos de acabamento, resistência à corrosão, normas técnicas e tudo o que você precisa saber para especificar o material correto.
				</p>
				<div class="flex flex-wrap gap-3">
					<span class="px-4 py-2 bg-neutral-100 rounded-full text-xs font-bold text-neutral-600 italic">#AISI304</span>
					<span class="px-4 py-2 bg-neutral-100 rounded-full text-xs font-bold text-neutral-600 italic">#ACABAMENTO</span>
					<span class="px-4 py-2 bg-neutral-100 rounded-full text-xs font-bold text-neutral-600 italic">#CORROSÃO</span>
				</div>
				<div class="pt-4">
					<a href="/wiki" class="inline-flex h-12 items-center justify-center rounded-full bg-black px-8 text-sm font-bold text-white transition-all hover:bg-neutral-800">
						Explorar Wiki
					</a>
				</div>
			</div>
			<div class="flex-1 w-full aspect-square md:aspect-auto md:h-[400px] bg-neutral-100 rounded-2xl overflow-hidden relative border border-black/5">
				<div class="absolute inset-0 flex items-center justify-center grayscale opacity-50">
					<div class="w-64 h-64 border-8 border-black/10 rounded-full flex items-center justify-center">
						<div class="w-48 h-48 border-4 border-black/5 rounded-full"></div>
					</div>
				</div>
			</div>
		</div>
	</section>
</Layout>
