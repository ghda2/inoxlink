---
import Layout from '../../layouts/Layout.astro';
import Newsletter from '../../components/Newsletter.astro';
import { db } from '../../db';
import { wiki, authors } from '../../db/schema';
import { eq } from 'drizzle-orm';

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect('/404');
}

const [item] = await db.select({
    id: wiki.id,
    title: wiki.title,
    slug: wiki.slug,
    content: wiki.content,
    createdAt: wiki.createdAt,
    updatedAt: wiki.updatedAt,
    metaTitle: wiki.metaTitle,
    metaDescription: wiki.metaDescription,
    ogImage: wiki.ogImage,
    authorName: authors.name,
    authorAvatar: authors.avatarUrl,
    authorBio: authors.bio,
})
.from(wiki)
.leftJoin(authors, eq(wiki.authorId, authors.id))
.where(eq(wiki.slug, slug))
.limit(1);

if (!item) {
    return Astro.redirect('/404');
}

const pageTitle = item.metaTitle || item.title;
const pageDescription = item.metaDescription || "Explicação técnica detalhada na Inox Wiki.";

export const prerender = false;
---

<Layout 
    title={pageTitle}
    description={pageDescription}
    image={item.ogImage}
    type="article"
>
    <!-- Custom Style for Wiki Content -->
    <style is:global>
        .wiki-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #374151; /* neutral-700 */
        }
        .wiki-content h2 {
            font-family: 'Inter', sans-serif;
            font-weight: 900;
            font-style: italic;
            text-transform: uppercase;
            font-size: 1.875rem;
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            letter-spacing: -0.05em;
            color: #111827;
            border-left: 4px solid #000;
            padding-left: 1rem;
        }
        .wiki-content h3 {
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1.25rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #111827;
        }
        .wiki-content p {
            margin-bottom: 1.5rem;
        }
        .wiki-content ul, .wiki-content ol {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }
        .wiki-content li {
            margin-bottom: 0.5rem;
        }
        .wiki-content strong {
            color: #000;
            font-weight: 700;
        }
        .wiki-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1.5rem;
            font-style: italic;
            color: #6b7280;
            margin: 2rem 0;
        }
    </style>

    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-12 pt-8">
        <!-- Main Content -->
        <article class="flex-1 space-y-12">
            <!-- Header -->
            <header class="space-y-8">
                <div class="flex items-center gap-2 text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em]">
                    <a href="/wiki" class="hover:text-black transition-colors">Inox Wiki</a>
                    <span class="w-1 h-1 bg-neutral-300 rounded-full"></span>
                    <span class="text-black">Artigo Técnico</span>
                </div>
                
                <h1 class="text-4xl md:text-6xl font-black tracking-tighter leading-[0.9] italic uppercase">
                    {item.title}
                </h1>

                <div class="flex items-center gap-4 text-xs font-bold text-neutral-500 uppercase tracking-widest border-y border-neutral-100 py-4">
                    <span>Publicado em: {new Date(item.createdAt || '').toLocaleDateString('pt-BR')}</span>
                    {item.updatedAt && (
                        <>
                            <span class="w-1 h-1 bg-neutral-300 rounded-full"></span>
                            <span>Atualizado: {new Date(item.updatedAt).toLocaleDateString('pt-BR')}</span>
                        </>
                    )}
                </div>
            </header>

            <!-- Content -->
            <div class="wiki-content">
                <Fragment set:html={item.content} />
            </div>

            <!-- Share -->
            <footer class="pt-12 border-t border-neutral-200">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-black uppercase tracking-widest text-neutral-400">Compartilhar:</span>
                        <div class="flex gap-2">
                             <button
                                onclick={`navigator.share({title: '${item.title}', url: window.location.href})`}
                                class="p-2 bg-neutral-100 hover:bg-black hover:text-white rounded-lg transition-all"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 100-3.316 3 3 0 000 3.316m0 6.632a3 3 0 100 3.316 3 3 0 000-3.316"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </footer>
        </article>

        <!-- Sidebar -->
        <aside class="w-full lg:w-80 space-y-8">
            <!-- Newsletter CTA Card -->
            <div class="bg-black text-white rounded-[2rem] p-8 space-y-6 sticky top-24 shadow-2xl shadow-black/20 overflow-hidden relative">
                {/* Decorative background element */}
                <div class="absolute -top-12 -right-12 w-32 h-32 bg-white/5 rounded-full blur-3xl"></div>
                
                <div class="relative z-10 space-y-6">
                    <div class="space-y-2">
                        <div class="inline-flex items-center gap-2 px-2 py-0.5 bg-white/10 rounded-full text-[8px] font-black uppercase tracking-widest text-white/60 border border-white/10">
                            Radar Inox
                        </div>
                        <h3 class="text-2xl font-black tracking-tighter italic uppercase leading-none">
                            Fique por dentro <br/> das <span class="text-neutral-400">normas</span>
                        </h3>
                        <p class="text-xs text-neutral-400 font-medium leading-relaxed">
                            Receba atualizações técnicas e avisos sobre novas revisões da Wiki diretamente no seu e-mail.
                        </p>
                    </div>

                    <form class="space-y-3">
                        <input 
                            type="email" 
                            placeholder="seu@email.com" 
                            class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-xs text-white placeholder:text-neutral-600 focus:outline-none focus:ring-1 focus:ring-white/30 transition-all font-medium"
                        />
                        <button class="w-full py-3 bg-white text-black text-[10px] font-black rounded-xl hover:bg-neutral-200 transition-all uppercase tracking-widest">
                            INSCREVER-ME
                        </button>
                    </form>

                    <div class="pt-2 flex items-center gap-2">
                        <div class="flex -space-x-2">
                            <div class="w-6 h-6 rounded-full border-2 border-black bg-neutral-800 flex items-center justify-center text-[8px] font-bold">+</div>
                            <div class="w-6 h-6 rounded-full border-2 border-black bg-neutral-700"></div>
                            <div class="w-6 h-6 rounded-full border-2 border-black bg-neutral-600"></div>
                        </div>
                        <span class="text-[9px] font-bold text-neutral-500 uppercase tracking-tight">+500 técnicos inscritos</span>
                    </div>
                </div>
            </div>

        </aside>
    </div>

    <!-- Bottom Section -->
    <div class="max-w-7xl mx-auto pt-24 pb-12">
        <Newsletter />
    </div>
</Layout>
