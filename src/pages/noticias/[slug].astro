---
import { db } from '../../db';
import { news, categories, authors } from '../../db/schema';
import { eq } from 'drizzle-orm';
import Layout from '../../layouts/Layout.astro';
import Newsletter from '../../components/Newsletter.astro';
import { Image } from 'astro:assets';
import { stripHtml, truncate } from '../../utils/seo-helpers';


const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect('/404');
}

// Get news with category and author info
const [item] = await db.select({
    id: news.id,
    title: news.title,
    slug: news.slug,
    excerpt: news.excerpt,
    content: news.content,
    imageUrl: news.imageUrl,
    imageAlt: news.imageAlt,
    createdAt: news.createdAt,
    publishedAt: news.publishedAt,
    readingTime: news.readingTime,
    tags: news.tags,

    // SEO fields
    metaTitle: news.metaTitle,
    metaDescription: news.metaDescription,
    keywords: news.keywords,
    canonicalUrl: news.canonicalUrl,
})
.from(news)
.leftJoin(categories, eq(news.categoryId, categories.id))
.leftJoin(authors, eq(news.authorId, authors.id))
.where(eq(news.slug, slug))
.limit(1);

if (!item) {
    return Astro.redirect('/404');
}

// SEO values with fallbacks
const pageTitle = item.metaTitle || item.title;
const pageDescription = item.metaDescription 
    ? truncate(item.metaDescription, 160)
    : (item.excerpt ? truncate(item.excerpt, 160) : truncate(stripHtml(item.content || ''), 160)) || "Leia mais sobre aço inox no Inox Link";

const pageImage = item.imageUrl || `https://inoxlink.com.br/og-default.jpg`;
const pageUrl = item.canonicalUrl || `https://inoxlink.com.br/noticias/${item.slug}`;
const publishedTime = item.publishedAt || item.createdAt;

// Structured Data (JSON-LD)
const structuredData = {
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": item.title,
    "image": item.imageUrl ? (item.imageUrl.startsWith('http') ? item.imageUrl : `${Astro.url.origin}${item.imageUrl}`) : undefined,
    "datePublished": publishedTime,
    "dateModified": item.createdAt,
    "author": item.authorName ? {
        "@type": "Person",
        "name": item.authorName,
        "url": item.authorSlug ? `${Astro.url.origin}/autores/${item.authorSlug}` : undefined
    } : {
        "@type": "Organization",
        "name": "Inox Link"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Inox Link",
        "logo": {
            "@type": "ImageObject",
            "url": `${Astro.url.origin}/logo.png`
        }
    },
    "description": pageDescription,
    "articleSection": item.categoryName || "Notícias",
    "keywords": item.keywords || undefined,
    "wordCount": item.content ? stripHtml(item.content).split(/\s+/).length : undefined,

    "timeRequired": item.readingTime ? `PT${item.readingTime}M` : undefined
};

export const prerender = false;
---

<Layout 
    title={pageTitle}
    description={pageDescription}
    image={pageImage}
    canonicalUrl={pageUrl}
    type="article"
    publishedTime={publishedTime}
    modifiedTime={item.createdAt}
    authorName={item.authorName}
    jsonLd={structuredData}
    breadcrumbs={[
        { name: 'Home', item: '/' },
        { name: 'Notícias', item: '/noticias' },
        ...(item.categoryName ? [{ name: item.categoryName, item: `/noticias?categoria=${item.categorySlug}` }] : []),
        { name: item.title, item: Astro.url.pathname }
    ]}
>
    
    <!-- Article Container -->
    <div class="bg-white">
        <!-- Breadcrumb & Meta -->
        <div class="border-b border-zinc-100">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <nav aria-label="Breadcrumb" class="flex items-center gap-2 text-[10px] font-bold text-zinc-600 uppercase tracking-wider">
                    <a href="/" class="hover:text-black transition-colors">Home</a>
                    <span>/</span>
                    <a href="/noticias" class="hover:text-black transition-colors">Notícias</a>
                    {item.categoryName && (
                        <>
                            <span>/</span>
                            <span class="text-black">{item.categoryName}</span>
                        </>
                    )}
                </nav>
            </div>
        </div>

        <!-- Article Header -->
        <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <header class="py-12 lg:py-16 space-y-8">
                <!-- Category Badge -->
                {item.categoryName && (
                    <div class="flex items-center gap-3">
                        <span class="inline-block px-4 py-1.5 bg-black text-white text-[10px] font-bold uppercase tracking-widest rounded-full">
                            {item.categoryName}
                        </span>
                        <span class="text-[11px] text-zinc-600 font-bold">
                            {new Date(publishedTime || '').toLocaleDateString('pt-BR', { 
                                day: 'numeric', 
                                month: 'long', 
                                year: 'numeric' 
                            })}
                        </span>
                    </div>
                )}

                <!-- Title -->
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight leading-[1.1] text-zinc-900">
                    {item.title}
                </h1>

                <!-- Excerpt -->
                {item.excerpt && (
                    <p class="text-lg sm:text-xl text-zinc-600 font-medium leading-relaxed max-w-3xl italic">
                        {item.excerpt}
                    </p>
                )}

                <!-- Author & Meta -->
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6 pt-6 border-t border-zinc-100">
                    <div class="flex items-center gap-4">
                        {item.authorAvatar ? (
                            <Image
                                src={item.authorAvatar}
                                alt={item.authorName || 'Autor'}
                                width={56}
                                height={56}
                                class="w-14 h-14 rounded-full object-cover ring-2 ring-zinc-100"
                            />
                        ) : (
                            <div class="w-14 h-14 bg-zinc-100 rounded-full flex items-center justify-center ring-2 ring-zinc-200">
                                <span class="text-base font-bold text-zinc-600">
                                    {item.authorName ? item.authorName.substring(0, 2).toUpperCase() : 'IL'}
                                </span>
                            </div>
                        )}
                        <div>
                            <p class="text-sm font-bold text-zinc-900">{item.authorName || 'Redação Inox Link'}</p>
                            <p class="text-xs text-zinc-600 font-bold mt-0.5">
                                {item.authorBio || 'Equipe Editorial'}
                            </p>
                        </div>
                    </div>
                    
                    {item.readingTime && (
                        <div class="flex items-center gap-2 text-zinc-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            <span class="text-sm font-bold">{item.readingTime} min de leitura</span>
                        </div>
                    )}
                </div>
            </header>

            <!-- Featured Image -->
            {item.imageUrl && (
                <figure class="my-12 lg:my-16">
                    <div class="relative aspect-[16/9] overflow-hidden rounded-2xl bg-zinc-100 shadow-sm border border-zinc-100">
                        <Image
                            src={item.imageUrl}
                            alt={item.imageAlt || item.title}
                            width={1200}
                            height={675}
                            loading="eager"
                            fetchpriority="high"
                            class="h-full w-full object-cover"
                        />
                    </div>
                    {item.imageAlt && (
                        <figcaption class="mt-3 text-center text-sm text-zinc-600 italic font-medium">
                            {item.imageAlt}
                        </figcaption>
                    )}
                </figure>
            )}

            <!-- Article Content -->
            <div class="article-content pb-12 lg:pb-16">
                <Fragment set:html={item.content} />
            </div>

            <!-- Tags & Share -->
            <footer class="py-12 border-t border-zinc-100">
                <div class="flex flex-col gap-8">
                    <!-- Tags -->
                    {item.tags && Array.isArray(item.tags) && (item.tags as string[]).length > 0 && (
                        <nav aria-label="Tags" class="flex flex-wrap gap-2">
                            {(item.tags as string[]).map((tag) => (
                                <span class="px-3 py-1.5 bg-zinc-100 hover:bg-zinc-200 rounded-lg text-xs font-bold text-zinc-700 transition-colors">
                                    #{tag}
                                </span>
                            ))}
                        </nav>
                    )}

                    <!-- Share Buttons -->
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-bold text-zinc-900">Compartilhar:</span>
                        <div class="flex gap-3">
                            <button
                                onclick={`navigator.share({title: '${item.title}', url: window.location.href})`}
                                class="p-2.5 bg-zinc-100 hover:bg-zinc-200 rounded-lg transition-all active:scale-95"
                                title="Compartilhar"
                                aria-label="Compartilhar matéria"
                            >
                                <svg class="w-5 h-5 text-zinc-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 100-3.316 3 3 0 000 3.316m0 6.632a3 3 0 100 3.316 3 3 0 000-3.316"></path></svg>
                            </button>
                            <a
                                href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(item.title)}&url=${encodeURIComponent(pageUrl)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="p-2.5 bg-zinc-100 hover:bg-zinc-200 rounded-lg transition-all active:scale-95"
                                title="Compartilhar no X (Twitter)"
                                aria-label="Compartilhar no X"
                            >
                                <svg class="w-5 h-5 text-zinc-700" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            </a>
                            <a
                                href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="p-2.5 bg-zinc-100 hover:bg-zinc-200 rounded-lg transition-all active:scale-95"
                                title="Compartilhar no LinkedIn"
                                aria-label="Compartilhar no LinkedIn"
                            >
                                <svg class="w-5 h-5 text-zinc-700" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                            </a>
                        </div>
                    </div>
                </div>
            </footer>
        </article>

        <!-- Newsletter CTA -->
        <div class="bg-zinc-50 border-y border-zinc-100">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16 lg:py-20">
                <Newsletter />
            </div>
        </div>
    </div>
</Layout>

<style is:global>
    /* Article Content Styles - Editorial Quality */
    .article-content {
        font-size: 1.125rem;
        line-height: 1.8;
        color: #18181b;
        font-weight: 400;
    }

    @media (max-width: 640px) {
        .article-content {
            font-size: 1.0625rem;
            line-height: 1.75;
        }
    }

    .article-content > *:first-child {
        margin-top: 0 !important;
    }

    .article-content h1,
    .article-content h2,
    .article-content h3 {
        font-weight: 700;
        color: #000000;
        letter-spacing: -0.025em;
        margin-top: 2.5em;
        margin-bottom: 1em;
        line-height: 1.25;
    }

    .article-content h1 {
        font-size: 2.25em;
        margin-top: 2em;
    }

    .article-content h2 {
        font-size: 1.875em;
    }

    .article-content h3 {
        font-size: 1.5em;
    }

    @media (max-width: 640px) {
        .article-content h1 {
            font-size: 1.875em;
        }
        .article-content h2 {
            font-size: 1.5em;
        }
        .article-content h3 {
            font-size: 1.25em;
        }
    }

    .article-content p {
        margin-top: 1.5em;
        margin-bottom: 1.5em;
    }

    .article-content strong {
        font-weight: 700;
        color: #000000;
    }

    .article-content em {
        font-style: italic;
    }

    .article-content a {
        color: #000000;
        font-weight: 700;
        text-decoration: underline;
        text-decoration-color: #d4d4d8;
        text-underline-offset: 3px;
        transition: all 0.2s;
    }

    .article-content a:hover {
        text-decoration-color: #000000;
    }

    .article-content ul,
    .article-content ol {
        margin-top: 1.75em;
        margin-bottom: 1.75em;
        padding-left: 1.5em;
    }

    .article-content ul {
        list-style-type: disc;
    }

    .article-content ol {
        list-style-type: decimal;
    }

    .article-content li {
        margin-top: 0.75em;
        margin-bottom: 0.75em;
        padding-left: 0.5em;
    }

    .article-content li::marker {
        color: #27272a;
        font-weight: bold;
    }

    .article-content img {
        max-width: 100%;
        height: auto;
        border-radius: 1rem;
        margin-top: 2.5em;
        margin-bottom: 2.5em;
    }

    .article-content blockquote {
        margin-top: 2.5em;
        margin-bottom: 2.5em;
        padding: 1.5em 0 1.5em 1.75em;
        border-left: 4px solid #000000;
        font-style: italic;
        color: #18181b;
        font-size: 1.125em;
        background: #f4f4f5;
        border-radius: 0 0.5rem 0.5rem 0;
    }

    .article-content blockquote p {
        margin: 0;
    }

    .article-content code {
        background-color: #f4f4f5;
        color: #000000;
        padding: 0.25em 0.5em;
        border-radius: 0.375rem;
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        font-size: 0.875em;
        font-weight: 600;
    }

    .article-content pre {
        background-color: #18181b;
        color: #fafafa;
        padding: 1.5em;
        border-radius: 0.75rem;
        overflow-x: auto;
        margin-top: 2em;
        margin-bottom: 2em;
        line-height: 1.6;
    }

    .article-content pre code {
        background-color: transparent;
        color: inherit;
        padding: 0;
        font-size: 0.9375em;
    }

    /* Horizontal Rule */
    .article-content hr {
        margin-top: 3em;
        margin-bottom: 3em;
        border: none;
        border-top: 2px solid #f4f4f5;
    }

    /* Tables */
    .article-content table {
        width: 100%;
        margin-top: 2.5em;
        margin-bottom: 2.5em;
        border-collapse: collapse;
        font-size: 0.9375rem;
        border: 1px solid #e4e4e7;
        border-radius: 0.75rem;
        overflow: hidden;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    @media (min-width: 768px) {
        .article-content table {
            display: table;
            white-space: normal;
        }
    }

    .article-content th {
        background-color: #f8f9fa;
        padding: 1rem 1.25rem;
        text-align: left;
        font-weight: 900;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #000000;
        border-bottom: 2px solid #e4e4e7;
    }

    .article-content td {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f4f4f5;
        color: #3f3f46;
        vertical-align: middle;
    }

    .article-content tr:last-child td {
        border-bottom: none;
    }

    .article-content tr:nth-child(even) {
        background-color: #fcfcfc;
    }

    .article-content tr:hover td {
        background-color: #f8f9fa;
        color: #000000;
    }

    /* First paragraph drop cap effect (optional) */
    .article-content > p:first-of-type::first-letter {
        font-size: 3.5em;
        font-weight: 800;
        line-height: 1;
        float: left;
        margin-right: 0.1em;
        margin-top: 0.05em;
        color: #000000;
    }
</style>
