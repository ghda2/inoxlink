---
import { db } from '../../db';
import { news, categories, authors } from '../../db/schema';
import { eq } from 'drizzle-orm';

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect('/404');
}

// Get news with category and author info
const [item] = await db.select({
    id: news.id,
    title: news.title,
    slug: news.slug,
    excerpt: news.excerpt,
    content: news.content,
    imageUrl: news.imageUrl,
    imageAlt: news.imageAlt,
    createdAt: news.createdAt,
    publishedAt: news.publishedAt,
    readingTime: news.readingTime,
    tags: news.tags,

    // SEO fields
    metaTitle: news.metaTitle,
    metaDescription: news.metaDescription,
    keywords: news.keywords,
    canonicalUrl: news.canonicalUrl,
    ogTitle: news.ogTitle,
    ogDescription: news.ogDescription,
    ogImage: news.ogImage,
    twitterCard: news.twitterCard,

    // Category
    categoryName: categories.name,
    categorySlug: categories.slug,

    // Author
    authorName: authors.name,
    authorSlug: authors.slug,
    authorAvatar: authors.avatarUrl,
    authorBio: authors.bio,
})
.from(news)
.leftJoin(categories, eq(news.categoryId, categories.id))
.leftJoin(authors, eq(news.authorId, authors.id))
.where(eq(news.slug, slug))
.limit(1);

if (!item) {
    return Astro.redirect('/404');
}

// SEO values with fallbacks
const pageTitle = item.metaTitle || item.title;
const pageDescription = item.metaDescription || item.excerpt || "Leia mais sobre aço inox no Inox Link";
const pageImage = item.ogImage || item.imageUrl || `${Astro.url.origin}/og-default.jpg`;
const pageUrl = item.canonicalUrl || `${Astro.url.origin}/noticias/${item.slug}`;
const publishedTime = item.publishedAt || item.createdAt;

// Structured Data (JSON-LD)
const structuredData = {
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": item.title,
    "image": item.imageUrl || undefined,
    "datePublished": publishedTime,
    "dateModified": item.createdAt,
    "author": item.authorName ? {
        "@type": "Person",
        "name": item.authorName,
        "url": item.authorSlug ? `${Astro.url.origin}/autores/${item.authorSlug}` : undefined
    } : {
        "@type": "Organization",
        "name": "Inox Link"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Inox Link",
        "logo": {
            "@type": "ImageObject",
            "url": `${Astro.url.origin}/logo.png`
        }
    },
    "description": pageDescription,
    "articleSection": item.categoryName || "Notícias",
    "keywords": item.keywords || undefined,
    "wordCount": item.content ? item.content.replace(/<[^>]*>/g, '').trim().split(/\s+/).length : undefined,
    "timeRequired": item.readingTime ? `PT${item.readingTime}M` : undefined
};

export const prerender = false;
---

<!doctype html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />

        <!-- Primary Meta Tags -->
        <title>{pageTitle} | Inox Link</title>
        <meta name="title" content={`${pageTitle} | Inox Link`} />
        <meta name="description" content={pageDescription} />
        {item.keywords && <meta name="keywords" content={item.keywords} />}
        <link rel="canonical" href={pageUrl} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="article" />
        <meta property="og:url" content={pageUrl} />
        <meta property="og:title" content={item.ogTitle || pageTitle} />
        <meta property="og:description" content={item.ogDescription || pageDescription} />
        <meta property="og:image" content={pageImage} />
        <meta property="og:site_name" content="Inox Link" />
        <meta property="og:locale" content="pt_BR" />
        {publishedTime && <meta property="article:published_time" content={publishedTime} />}
        {item.categoryName && <meta property="article:section" content={item.categoryName} />}
        {item.authorName && <meta property="article:author" content={item.authorName} />}
        {item.tags && Array.isArray(item.tags) && (item.tags as string[]).map((tag) => (
            <meta property="article:tag" content={tag} />
        ))}

        <!-- Twitter -->
        <meta property="twitter:card" content={item.twitterCard || "summary_large_image"} />
        <meta property="twitter:url" content={pageUrl} />
        <meta property="twitter:title" content={item.ogTitle || pageTitle} />
        <meta property="twitter:description" content={item.ogDescription || pageDescription} />
        <meta property="twitter:image" content={pageImage} />

        <!-- Structured Data -->
        <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

        <!-- Tailwind CSS -->
        <style is:global>
            @import "tailwindcss";
        </style>
    </head>
    <body class="bg-[#f8f9fa] text-[#1a1a1a] min-h-screen font-['Inter',sans-serif] selection:bg-black selection:text-white">
        <div class="fixed inset-0 -z-10 bg-[radial-gradient(45%_45%_at_50%_50%,#e5e7eb_0%,#f8f9fa_100%)]"></div>

        <nav class="sticky top-0 z-50 w-full border-b border-white/20 bg-white/60 backdrop-blur-xl">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center">
                        <a href="/" class="text-2xl font-black tracking-tighter text-black flex items-center gap-2">
                            <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
                                <div class="w-4 h-4 border-2 border-white rounded-sm rotate-45"></div>
                            </div>
                            <span>INOX<span class="text-neutral-500">LINK</span></span>
                        </a>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-8">
                            <a href="/" class="text-sm font-medium hover:text-neutral-500 transition-colors">Início</a>
                            <a href="/noticias" class="text-sm font-medium hover:text-neutral-500 transition-colors">Notícias</a>
                            <a href="/wiki" class="text-sm font-medium hover:text-neutral-500 transition-colors">Wiki</a>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button class="px-4 py-2 bg-black text-white text-xs font-bold rounded-full transform active:scale-95 transition-all hover:bg-neutral-800">
                            NOTIFICAR-ME
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <article class="max-w-4xl mx-auto space-y-12">
                <!-- Header -->
                <header class="space-y-8 text-center pt-8">
                    <div class="flex items-center justify-center gap-2 text-xs font-black text-neutral-400 uppercase tracking-[0.2em] flex-wrap">
                        <a href="/noticias" class="hover:text-black transition-colors">Notícias</a>
                        {item.categoryName && (
                            <>
                                <span class="w-1 h-1 bg-neutral-300 rounded-full"></span>
                                <span class="text-black">{item.categoryName}</span>
                            </>
                        )}
                        <span class="w-1 h-1 bg-neutral-300 rounded-full"></span>
                        <span>{new Date(item.createdAt || '').toLocaleDateString('pt-BR')}</span>
                        {item.readingTime && (
                            <>
                                <span class="w-1 h-1 bg-neutral-300 rounded-full"></span>
                                <span>{item.readingTime} min de leitura</span>
                            </>
                        )}
                    </div>

                    <h1 class="text-4xl md:text-6xl font-black tracking-tighter leading-tight italic uppercase">
                        {item.title}
                    </h1>

                    {item.excerpt && (
                        <p class="text-xl text-neutral-500 font-medium max-w-2xl mx-auto leading-relaxed">
                            {item.excerpt}
                        </p>
                    )}

                    <!-- Author Info -->
                    <div class="flex items-center justify-center gap-4 pt-4">
                        {item.authorAvatar ? (
                            <img
                                src={item.authorAvatar}
                                alt={item.authorName || 'Autor'}
                                class="w-12 h-12 rounded-full object-cover border-2 border-neutral-200"
                            />
                        ) : (
                            <div class="w-12 h-12 bg-neutral-100 rounded-full flex items-center justify-center border-2 border-neutral-200">
                                <span class="text-sm font-bold">{item.authorName ? item.authorName.substring(0, 2).toUpperCase() : 'IL'}</span>
                            </div>
                        )}
                        <div class="text-left">
                            <p class="text-sm font-bold">{item.authorName || 'Redação Inox Link'}</p>
                            <p class="text-[10px] text-neutral-400 font-bold uppercase tracking-widest">
                                {item.authorBio ? item.authorBio.substring(0, 40) + '...' : 'Equipe Editorial'}
                            </p>
                        </div>
                    </div>
                </header>

                <!-- Featured Image -->
                {item.imageUrl && (
                    <div class="relative aspect-[21/9] overflow-hidden rounded-[2.5rem] bg-neutral-100 border border-neutral-200">
                        <img
                            src={item.imageUrl}
                            alt={item.imageAlt || item.title}
                            class="h-full w-full object-cover"
                        />
                    </div>
                )}

                <!-- Content -->
                <div class="article-content max-w-none mx-auto">
                    <Fragment set:html={item.content} />
                </div>

                <!-- Share & Tags -->
                <footer class="pt-12 border-t border-neutral-200">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                            {item.tags && Array.isArray(item.tags) && (item.tags as string[]).length > 0 ? (
                                (item.tags as string[]).map((tag) => (
                                    <span class="px-4 py-2 bg-neutral-100 rounded-full text-xs font-bold text-neutral-500 italic">
                                        #{tag}
                                    </span>
                                ))
                            ) : (
                                <>
                                    <span class="px-4 py-2 bg-neutral-100 rounded-full text-xs font-bold text-neutral-500 italic">#INOX</span>
                                    <span class="px-4 py-2 bg-neutral-100 rounded-full text-xs font-bold text-neutral-500 italic">#NOTICIAS</span>
                                </>
                            )}
                        </div>
                        <div class="flex gap-4">
                            <button
                                onclick={`navigator.share({title: '${item.title}', url: window.location.href})`}
                                class="p-3 bg-neutral-100 hover:bg-neutral-200 rounded-full transition-colors"
                                title="Compartilhar"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 100-3.316 3 3 0 000 3.316m0 6.632a3 3 0 100 3.316 3 3 0 000-3.316"></path></svg>
                            </button>
                            <a
                                href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(item.title)}&url=${encodeURIComponent(pageUrl)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="p-3 bg-neutral-100 hover:bg-neutral-200 rounded-full transition-colors"
                                title="Compartilhar no Twitter"
                            >
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"></path></svg>
                            </a>
                        </div>
                    </div>
                </footer>
            </article>
        </main>

        <footer class="mt-20 border-t border-neutral-200 bg-white/40 py-12 backdrop-blur-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <p class="text-sm text-neutral-500 font-medium">© 2024 Inox Link. Todos os direitos reservados.</p>
            </div>
        </footer>
    </body>
</html>

<style is:global>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.6);
        --glass-border: rgba(255, 255, 255, 0.2);
    }

    .glass {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    }

    ::-webkit-scrollbar {
        width: 10px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
        background: #d1d1d1;
        border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }

    /* Article Content Styles */
    .article-content {
        font-size: 1.125rem;
        line-height: 1.75;
        color: #525252;
    }

    .article-content h1 {
        font-size: 2.5em;
        font-weight: 900;
        margin-top: 1.5em;
        margin-bottom: 0.75em;
        line-height: 1.1;
        letter-spacing: -0.02em;
        font-style: italic;
        text-transform: uppercase;
        color: #1a1a1a;
    }

    .article-content h2 {
        font-size: 2em;
        font-weight: 900;
        margin-top: 1.5em;
        margin-bottom: 0.75em;
        line-height: 1.2;
        letter-spacing: -0.02em;
        font-style: italic;
        text-transform: uppercase;
        color: #1a1a1a;
    }

    .article-content h3 {
        font-size: 1.5em;
        font-weight: 900;
        margin-top: 1.5em;
        margin-bottom: 0.75em;
        line-height: 1.3;
        letter-spacing: -0.02em;
        font-style: italic;
        text-transform: uppercase;
        color: #1a1a1a;
    }

    .article-content p {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
        color: #525252;
        font-weight: 500;
    }

    .article-content p:first-child {
        margin-top: 0;
    }

    .article-content strong {
        font-weight: 700;
        color: #1a1a1a;
    }

    .article-content em {
        font-style: italic;
    }

    .article-content u {
        text-decoration: underline;
    }

    .article-content a {
        color: #1a1a1a;
        font-weight: 700;
        text-decoration: none;
        border-bottom: 2px solid #1a1a1a;
        transition: opacity 0.2s;
    }

    .article-content a:hover {
        opacity: 0.7;
    }

    .article-content ul,
    .article-content ol {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
        padding-left: 1.75em;
    }

    .article-content ul {
        list-style-type: disc;
    }

    .article-content ol {
        list-style-type: decimal;
    }

    .article-content li {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
        padding-left: 0.5em;
    }

    .article-content li::marker {
        color: #1a1a1a;
        font-weight: 700;
    }

    .article-content img {
        max-width: 100%;
        height: auto;
        border-radius: 1.5rem;
        border: 1px solid #e5e5e5;
        margin-top: 2em;
        margin-bottom: 2em;
    }

    .article-content blockquote {
        margin-top: 2em;
        margin-bottom: 2em;
        padding-left: 1.5em;
        border-left: 4px solid #1a1a1a;
        font-style: italic;
        color: #525252;
    }

    .article-content code {
        background-color: #f5f5f5;
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .article-content pre {
        background-color: #f5f5f5;
        padding: 1em;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-top: 1.5em;
        margin-bottom: 1.5em;
    }

    .article-content pre code {
        background-color: transparent;
        padding: 0;
    }

    /* Text alignment from TipTap */
    .article-content [style*="text-align: left"] {
        text-align: left;
    }

    .article-content [style*="text-align: center"] {
        text-align: center;
    }

    .article-content [style*="text-align: right"] {
        text-align: right;
    }
</style>
